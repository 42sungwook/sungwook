# .github/workflows/deploy-home.yml
name: Deploy Home to AWS

on:
  push:
    branches: [home]
  pull_request:
    branches: [home]

env:
  NODE_VERSION: '18'
  BUN_VERSION: 'latest'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 1
          token: ${{ secrets.ACCESS_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install

      # home ì•±ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
      - name: Check if home app exists
        run: |
          if bunx nx show project home > /dev/null 2>&1; then
            echo "âœ… Home app found"
            echo "HOME_EXISTS=true" >> $GITHUB_ENV
          else
            echo "âŒ Home app not found"
            echo "Available apps:"
            bunx nx show projects
            echo "HOME_EXISTS=false" >> $GITHUB_ENV
            exit 1
          fi

      # home ì•±ë§Œ ë¹Œë“œ
      - name: Build home application
        if: env.HOME_EXISTS == 'true'
        run: |
          echo "ğŸ—ï¸ Building home application..."
          bunx nx build home

          # ìµœì¢… ë¹Œë“œ ê²°ê³¼ í™•ì¸
          if [ -d "dist/apps/home" ] && [ "$(ls -A dist/apps/home)" ]; then
            echo "âœ… Home build successful"
            echo "ğŸ“„ Build contents:"
            ls -la dist/apps/home/
          else
            echo "âŒ Home build failed - no output found"
            exit 1
          fi

      - name: Configure AWS credentials
        if: env.HOME_EXISTS == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # home ë¸Œëœì¹˜ì— í‘¸ì‹œí•  ë•Œë§Œ ë°°í¬ (PRì€ ì œì™¸)
      - name: Deploy home to S3
        if: env.HOME_EXISTS == 'true' && github.ref == 'refs/heads/home' && github.event_name == 'push'
        run: |
          echo "ğŸš€ Deploying home to S3..."

          aws s3 sync dist/apps/home s3://${{ secrets.HOME_S3_BUCKET_NAME }} \
            --delete \
            --exact-timestamps

          echo "âœ… Home deployed to S3"

      - name: Invalidate CloudFront cache
        if: env.HOME_EXISTS == 'true' && github.ref == 'refs/heads/home' && github.event_name == 'push'
        run: |
          echo "ğŸ”„ Invalidating CloudFront cache..."

          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.HOME_CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

          echo "âœ… CloudFront invalidation created"

  # í…ŒìŠ¤íŠ¸ ì‘ì—… (PRìš©)
  test-home:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install

      - name: Run home linting
        run: |
          echo "ğŸ” Linting home application..."

          # ë¦°íŒ…ì´ ì„¤ì •ë˜ì–´ ìˆëŠ” ê²½ìš° ì‹¤í–‰
          if bunx nx lint blog --help > /dev/null 2>&1; then
            echo "Running home linting..."
            bunx nx lint home
          else
            echo "â„¹ï¸ No linting configured for home app"
          fi

      - name: Build check for home
        run: |
          echo "ğŸ—ï¸ Build check for home application..."
          bunx nx build home

          # ë¹Œë“œ ê²°ê³¼ í™•ì¸
          if [ -d "dist/apps/home" ]; then
            echo "âœ… Home build check passed"
          else
            echo "âŒ Home build check failed"
            exit 1
          fi
