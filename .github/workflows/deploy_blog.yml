name: Deploy Blog to AWS

on:
  push:
    branches: [blog]
  pull_request:
    branches: [blog]

env:
  NODE_VERSION: '18'
  BUN_VERSION: 'latest'
  APP_NAME: 'blog'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'bun'

      - name: Install dependencies
        run: bun install

      - name: Nx Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.nx
            node_modules/.cache/nx
          key: ${{ runner.os }}-nx-blog-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-nx-blog-
            ${{ runner.os }}-nx-

      # blog ì•±ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
      - name: Check if blog app exists
        run: |
          if bunx nx show project blog > /dev/null 2>&1; then
            echo "âœ… Blog app found"
            echo "BLOG_EXISTS=true" >> $GITHUB_ENV
          else
            echo "âŒ Blog app not found"
            echo "Available apps:"
            bunx nx show projects
            echo "BLOG_EXISTS=false" >> $GITHUB_ENV
            exit 1
          fi

      # blog ì•±ë§Œ ë¹Œë“œ
      - name: Build blog application
        if: env.BLOG_EXISTS == 'true'
        run: |
          echo "ğŸ—ï¸ Building blog application..."
          bunx nx build blog

          # ë¹Œë“œ ê²°ê³¼ í™•ì¸
          echo "ğŸ“ Build output:"
          ls -la dist/apps/blog/ || ls -la apps/blog/doc_build/ || echo "Build output not found"

          # RSPress ë¹Œë“œ ê²°ê³¼ ì²˜ë¦¬ (í•„ìš”í•œ ê²½ìš°)
          if [ -d "apps/blog/doc_build" ]; then
            echo "ğŸ“š RSPress build detected, copying to standard dist location"
            mkdir -p dist/apps/blog
            cp -r apps/blog/doc_build/* dist/apps/blog/
            echo "âœ… RSPress content copied"
          fi

          # ìµœì¢… ë¹Œë“œ ê²°ê³¼ í™•ì¸
          if [ -d "dist/apps/blog" ] && [ "$(ls -A dist/apps/blog)" ]; then
            echo "âœ… Blog build successful"
            echo "ğŸ“„ Build contents:"
            ls -la dist/apps/blog/
          else
            echo "âŒ Blog build failed - no output found"
            exit 1
          fi

      - name: Configure AWS credentials
        if: env.BLOG_EXISTS == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # blog ë¸Œëœì¹˜ì— í‘¸ì‹œí•  ë•Œë§Œ ë°°í¬ (PRì€ ì œì™¸)
      - name: Deploy blog to S3
        if: env.BLOG_EXISTS == 'true' && github.ref == 'refs/heads/blog' && github.event_name == 'push'
        run: |
          echo "ğŸš€ Deploying blog to S3..."

          # S3 ë™ê¸°í™” ì‹¤í–‰
          aws s3 sync dist/apps/blog s3://${{ secrets.S3_BUCKET_NAME }} \
            --delete \
            --exact-timestamps \
            --cache-control "public,max-age=3600" \
            --metadata-directive REPLACE

          echo "âœ… Blog deployed to S3"

      - name: Invalidate CloudFront cache
        if: env.BLOG_EXISTS == 'true' && github.ref == 'refs/heads/blog' && github.event_name == 'push'
        run: |
          echo "ğŸ”„ Invalidating CloudFront cache..."

          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)

          echo "âœ… CloudFront invalidation created: $INVALIDATION_ID"
          echo "â³ Cache invalidation may take 10-15 minutes to complete"

      # ë°°í¬ ì„±ê³µ ì•Œë¦¼
      - name: Deployment success notification
        if: env.BLOG_EXISTS == 'true' && github.ref == 'refs/heads/blog' && github.event_name == 'push'
        run: |
          echo "ğŸ‰ Blog deployment completed successfully!"
          echo "ğŸŒ Your blog should be available at: https://${{ secrets.S3_BUCKET_NAME }}"
          echo "â° CloudFront cache invalidation is in progress..."

  # í…ŒìŠ¤íŠ¸ ì‘ì—… (PRìš©)
  test-blog:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install

      # blog ì•± í…ŒìŠ¤íŠ¸
      - name: Run blog tests
        run: |
          echo "ğŸ§ª Testing blog application..."

          # í…ŒìŠ¤íŠ¸ê°€ ì„¤ì •ë˜ì–´ ìˆëŠ” ê²½ìš° ì‹¤í–‰
          if bunx nx test blog --help > /dev/null 2>&1; then
            echo "Running blog tests..."
            bunx nx test blog
          else
            echo "â„¹ï¸ No tests configured for blog app"
          fi

      - name: Run blog linting
        run: |
          echo "ğŸ” Linting blog application..."

          # ë¦°íŒ…ì´ ì„¤ì •ë˜ì–´ ìˆëŠ” ê²½ìš° ì‹¤í–‰
          if bunx nx lint blog --help > /dev/null 2>&1; then
            echo "Running blog linting..."
            bunx nx lint blog
          else
            echo "â„¹ï¸ No linting configured for blog app"
          fi

      - name: Build check for blog
        run: |
          echo "ğŸ—ï¸ Build check for blog application..."
          bunx nx build blog

          # ë¹Œë“œ ê²°ê³¼ í™•ì¸
          if [ -d "dist/apps/blog" ] || [ -d "apps/blog/doc_build" ]; then
            echo "âœ… Blog build check passed"
          else
            echo "âŒ Blog build check failed"
            exit 1
          fi
